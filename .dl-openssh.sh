#!/usr/bin/env bash
export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
TZ='UTC'; export TZ

set -e

_old_dir="$(pwd)"
_tmp_dir="$(mktemp -d)"
cd "${_tmp_dir}"

git clone "git://anongit.mindrot.org/openssh.git" openssh.tmp

_ver=$(grep -i '#define SSH_VERSION' openssh.tmp/version.h | head -1 | awk '{print $NF}' | sed 's/"//g' | sed 's/OpenSSH_//g')
_port=$(grep -i '#define SSH_PORTABLE' openssh.tmp/version.h | head -1 | awk '{print $NF}' | sed 's/"//g')
echo
echo "${_ver}  ${_port}"
echo
mv -f openssh.tmp "openssh-${_ver}${_port}"
sleep 1

############################################################################
cd "openssh-${_ver}${_port}"

sleep 1
git log | grep '^commit' | head -n 1 > .gitversion
cat .gitversion
echo

rm -f configure.ac.orig
rm -f sshd.c.orig
# Patch
rm -fr /tmp/systemd-readiness.patch
sleep 1
printf '\x64\x69\x66\x66\x20\x2D\x2D\x67\x69\x74\x20\x61\x2F\x63\x6F\x6E\x66\x69\x67\x75\x72\x65\x2E\x61\x63\x20\x62\x2F\x63\x6F\x6E\x66\x69\x67\x75\x72\x65\x2E\x61\x63\x0A\x69\x6E\x64\x65\x78\x20\x63\x62\x66\x32\x37\x64\x62\x32\x2E\x2E\x38\x33\x35\x39\x37\x36\x34\x63\x20\x31\x30\x30\x36\x34\x34\x0A\x2D\x2D\x2D\x20\x61\x2F\x63\x6F\x6E\x66\x69\x67\x75\x72\x65\x2E\x61\x63\x0A\x2B\x2B\x2B\x20\x62\x2F\x63\x6F\x6E\x66\x69\x67\x75\x72\x65\x2E\x61\x63\x0A\x40\x40\x20\x2D\x34\x37\x34\x38\x2C\x36\x20\x2B\x34\x37\x34\x38\x2C\x32\x39\x20\x40\x40\x20\x41\x43\x5F\x41\x52\x47\x5F\x57\x49\x54\x48\x28\x5B\x6B\x65\x72\x62\x65\x72\x6F\x73\x35\x5D\x2C\x0A\x20\x41\x43\x5F\x53\x55\x42\x53\x54\x28\x5B\x47\x53\x53\x4C\x49\x42\x53\x5D\x29\x0A\x20\x41\x43\x5F\x53\x55\x42\x53\x54\x28\x5B\x4B\x35\x4C\x49\x42\x53\x5D\x29\x0A\x20\x0A\x2B\x23\x20\x43\x68\x65\x63\x6B\x20\x77\x68\x65\x74\x68\x65\x72\x20\x75\x73\x65\x72\x20\x77\x61\x6E\x74\x73\x20\x73\x79\x73\x74\x65\x6D\x64\x20\x73\x75\x70\x70\x6F\x72\x74\x0A\x2B\x53\x59\x53\x54\x45\x4D\x44\x5F\x4D\x53\x47\x3D\x22\x6E\x6F\x22\x0A\x2B\x41\x43\x5F\x41\x52\x47\x5F\x57\x49\x54\x48\x28\x73\x79\x73\x74\x65\x6D\x64\x2C\x0A\x2B\x09\x5B\x20\x20\x2D\x2D\x77\x69\x74\x68\x2D\x73\x79\x73\x74\x65\x6D\x64\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x45\x6E\x61\x62\x6C\x65\x20\x73\x79\x73\x74\x65\x6D\x64\x20\x73\x75\x70\x70\x6F\x72\x74\x5D\x2C\x0A\x2B\x09\x5B\x20\x69\x66\x20\x74\x65\x73\x74\x20\x22\x78\x24\x77\x69\x74\x68\x76\x61\x6C\x22\x20\x21\x3D\x20\x22\x78\x6E\x6F\x22\x20\x3B\x20\x74\x68\x65\x6E\x0A\x2B\x09\x09\x41\x43\x5F\x50\x41\x54\x48\x5F\x54\x4F\x4F\x4C\x28\x5B\x50\x4B\x47\x43\x4F\x4E\x46\x49\x47\x5D\x2C\x20\x5B\x70\x6B\x67\x2D\x63\x6F\x6E\x66\x69\x67\x5D\x2C\x20\x5B\x6E\x6F\x5D\x29\x0A\x2B\x09\x09\x69\x66\x20\x74\x65\x73\x74\x20\x22\x24\x50\x4B\x47\x43\x4F\x4E\x46\x49\x47\x22\x20\x21\x3D\x20\x22\x6E\x6F\x22\x3B\x20\x74\x68\x65\x6E\x0A\x2B\x09\x09\x09\x41\x43\x5F\x4D\x53\x47\x5F\x43\x48\x45\x43\x4B\x49\x4E\x47\x28\x5B\x66\x6F\x72\x20\x6C\x69\x62\x73\x79\x73\x74\x65\x6D\x64\x5D\x29\x0A\x2B\x09\x09\x09\x69\x66\x20\x24\x50\x4B\x47\x43\x4F\x4E\x46\x49\x47\x20\x2D\x2D\x65\x78\x69\x73\x74\x73\x20\x6C\x69\x62\x73\x79\x73\x74\x65\x6D\x64\x3B\x20\x74\x68\x65\x6E\x0A\x2B\x09\x09\x09\x09\x53\x59\x53\x54\x45\x4D\x44\x5F\x43\x46\x4C\x41\x47\x53\x3D\x60\x24\x50\x4B\x47\x43\x4F\x4E\x46\x49\x47\x20\x2D\x2D\x63\x66\x6C\x61\x67\x73\x20\x6C\x69\x62\x73\x79\x73\x74\x65\x6D\x64\x60\x0A\x2B\x09\x09\x09\x09\x53\x59\x53\x54\x45\x4D\x44\x5F\x4C\x49\x42\x53\x3D\x60\x24\x50\x4B\x47\x43\x4F\x4E\x46\x49\x47\x20\x2D\x2D\x6C\x69\x62\x73\x20\x6C\x69\x62\x73\x79\x73\x74\x65\x6D\x64\x60\x0A\x2B\x09\x09\x09\x09\x43\x50\x50\x46\x4C\x41\x47\x53\x3D\x22\x24\x43\x50\x50\x46\x4C\x41\x47\x53\x20\x24\x53\x59\x53\x54\x45\x4D\x44\x5F\x43\x46\x4C\x41\x47\x53\x22\x0A\x2B\x09\x09\x09\x09\x53\x53\x48\x44\x4C\x49\x42\x53\x3D\x22\x24\x53\x53\x48\x44\x4C\x49\x42\x53\x20\x24\x53\x59\x53\x54\x45\x4D\x44\x5F\x4C\x49\x42\x53\x22\x0A\x2B\x09\x09\x09\x09\x41\x43\x5F\x4D\x53\x47\x5F\x52\x45\x53\x55\x4C\x54\x28\x5B\x79\x65\x73\x5D\x29\x0A\x2B\x09\x09\x09\x09\x41\x43\x5F\x44\x45\x46\x49\x4E\x45\x28\x48\x41\x56\x45\x5F\x53\x59\x53\x54\x45\x4D\x44\x2C\x20\x31\x2C\x20\x5B\x44\x65\x66\x69\x6E\x65\x20\x69\x66\x20\x79\x6F\x75\x20\x77\x61\x6E\x74\x20\x73\x79\x73\x74\x65\x6D\x64\x20\x73\x75\x70\x70\x6F\x72\x74\x2E\x5D\x29\x0A\x2B\x09\x09\x09\x09\x53\x59\x53\x54\x45\x4D\x44\x5F\x4D\x53\x47\x3D\x22\x79\x65\x73\x22\x0A\x2B\x09\x09\x09\x65\x6C\x73\x65\x0A\x2B\x09\x09\x09\x09\x41\x43\x5F\x4D\x53\x47\x5F\x52\x45\x53\x55\x4C\x54\x28\x5B\x6E\x6F\x5D\x29\x0A\x2B\x09\x09\x09\x66\x69\x0A\x2B\x09\x09\x66\x69\x0A\x2B\x09\x66\x69\x20\x5D\x0A\x2B\x29\x0A\x2B\x0A\x20\x23\x20\x4C\x6F\x6F\x6B\x69\x6E\x67\x20\x66\x6F\x72\x20\x70\x72\x6F\x67\x72\x61\x6D\x73\x2C\x20\x70\x61\x74\x68\x73\x20\x61\x6E\x64\x20\x66\x69\x6C\x65\x73\x0A\x20\x0A\x20\x50\x52\x49\x56\x53\x45\x50\x5F\x50\x41\x54\x48\x3D\x2F\x76\x61\x72\x2F\x65\x6D\x70\x74\x79\x0A\x40\x40\x20\x2D\x35\x35\x36\x31\x2C\x36\x20\x2B\x35\x35\x38\x34\x2C\x37\x20\x40\x40\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x6C\x69\x62\x6C\x64\x6E\x73\x20\x73\x75\x70\x70\x6F\x72\x74\x3A\x20\x24\x4C\x44\x4E\x53\x5F\x4D\x53\x47\x22\x0A\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x53\x6F\x6C\x61\x72\x69\x73\x20\x70\x72\x6F\x63\x65\x73\x73\x20\x63\x6F\x6E\x74\x72\x61\x63\x74\x20\x73\x75\x70\x70\x6F\x72\x74\x3A\x20\x24\x53\x50\x43\x5F\x4D\x53\x47\x22\x0A\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x53\x6F\x6C\x61\x72\x69\x73\x20\x70\x72\x6F\x6A\x65\x63\x74\x20\x73\x75\x70\x70\x6F\x72\x74\x3A\x20\x24\x53\x50\x5F\x4D\x53\x47\x22\x0A\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x20\x20\x53\x6F\x6C\x61\x72\x69\x73\x20\x70\x72\x69\x76\x69\x6C\x65\x67\x65\x20\x73\x75\x70\x70\x6F\x72\x74\x3A\x20\x24\x53\x50\x50\x5F\x4D\x53\x47\x22\x0A\x2B\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x73\x79\x73\x74\x65\x6D\x64\x20\x73\x75\x70\x70\x6F\x72\x74\x3A\x20\x24\x53\x59\x53\x54\x45\x4D\x44\x5F\x4D\x53\x47\x22\x0A\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x49\x50\x20\x61\x64\x64\x72\x65\x73\x73\x20\x69\x6E\x20\x5C\x24\x44\x49\x53\x50\x4C\x41\x59\x20\x68\x61\x63\x6B\x3A\x20\x24\x44\x49\x53\x50\x4C\x41\x59\x5F\x48\x41\x43\x4B\x5F\x4D\x53\x47\x22\x0A\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x54\x72\x61\x6E\x73\x6C\x61\x74\x65\x20\x76\x34\x20\x69\x6E\x20\x76\x36\x20\x68\x61\x63\x6B\x3A\x20\x24\x49\x50\x56\x34\x5F\x49\x4E\x36\x5F\x48\x41\x43\x4B\x5F\x4D\x53\x47\x22\x0A\x20\x65\x63\x68\x6F\x20\x22\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x42\x53\x44\x20\x41\x75\x74\x68\x20\x73\x75\x70\x70\x6F\x72\x74\x3A\x20\x24\x42\x53\x44\x5F\x41\x55\x54\x48\x5F\x4D\x53\x47\x22\x0A\x64\x69\x66\x66\x20\x2D\x2D\x67\x69\x74\x20\x61\x2F\x73\x73\x68\x64\x2E\x63\x20\x62\x2F\x73\x73\x68\x64\x2E\x63\x0A\x69\x6E\x64\x65\x78\x20\x65\x61\x36\x33\x64\x30\x33\x30\x2E\x2E\x66\x30\x38\x34\x63\x38\x36\x38\x20\x31\x30\x30\x36\x34\x34\x0A\x2D\x2D\x2D\x20\x61\x2F\x73\x73\x68\x64\x2E\x63\x0A\x2B\x2B\x2B\x20\x62\x2F\x73\x73\x68\x64\x2E\x63\x0A\x40\x40\x20\x2D\x38\x35\x2C\x36\x20\x2B\x38\x35\x2C\x31\x30\x20\x40\x40\x0A\x20\x23\x69\x6E\x63\x6C\x75\x64\x65\x20\x3C\x70\x72\x6F\x74\x2E\x68\x3E\x0A\x20\x23\x65\x6E\x64\x69\x66\x0A\x20\x0A\x2B\x23\x69\x66\x64\x65\x66\x20\x48\x41\x56\x45\x5F\x53\x59\x53\x54\x45\x4D\x44\x0A\x2B\x23\x69\x6E\x63\x6C\x75\x64\x65\x20\x3C\x73\x79\x73\x74\x65\x6D\x64\x2F\x73\x64\x2D\x64\x61\x65\x6D\x6F\x6E\x2E\x68\x3E\x0A\x2B\x23\x65\x6E\x64\x69\x66\x0A\x2B\x0A\x20\x23\x69\x6E\x63\x6C\x75\x64\x65\x20\x22\x78\x6D\x61\x6C\x6C\x6F\x63\x2E\x68\x22\x0A\x20\x23\x69\x6E\x63\x6C\x75\x64\x65\x20\x22\x73\x73\x68\x2E\x68\x22\x0A\x20\x23\x69\x6E\x63\x6C\x75\x64\x65\x20\x22\x73\x73\x68\x32\x2E\x68\x22\x0A\x40\x40\x20\x2D\x32\x30\x37\x30\x2C\x36\x20\x2B\x32\x30\x37\x34\x2C\x31\x31\x20\x40\x40\x20\x6D\x61\x69\x6E\x28\x69\x6E\x74\x20\x61\x63\x2C\x20\x63\x68\x61\x72\x20\x2A\x2A\x61\x76\x29\x0A\x20\x09\x09\x09\x7D\x0A\x20\x09\x09\x7D\x0A\x20\x0A\x2B\x23\x69\x66\x64\x65\x66\x20\x48\x41\x56\x45\x5F\x53\x59\x53\x54\x45\x4D\x44\x0A\x2B\x09\x09\x2F\x2A\x20\x53\x69\x67\x6E\x61\x6C\x20\x73\x79\x73\x74\x65\x6D\x64\x20\x74\x68\x61\x74\x20\x77\x65\x20\x61\x72\x65\x20\x72\x65\x61\x64\x79\x20\x74\x6F\x20\x61\x63\x63\x65\x70\x74\x20\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E\x73\x20\x2A\x2F\x0A\x2B\x09\x09\x73\x64\x5F\x6E\x6F\x74\x69\x66\x79\x28\x30\x2C\x20\x22\x52\x45\x41\x44\x59\x3D\x31\x22\x29\x3B\x0A\x2B\x23\x65\x6E\x64\x69\x66\x0A\x2B\x0A\x20\x09\x09\x2F\x2A\x20\x41\x63\x63\x65\x70\x74\x20\x61\x20\x63\x6F\x6E\x6E\x65\x63\x74\x69\x6F\x6E\x20\x61\x6E\x64\x20\x72\x65\x74\x75\x72\x6E\x20\x69\x6E\x20\x61\x20\x66\x6F\x72\x6B\x65\x64\x20\x63\x68\x69\x6C\x64\x20\x2A\x2F\x0A\x20\x09\x09\x73\x65\x72\x76\x65\x72\x5F\x61\x63\x63\x65\x70\x74\x5F\x6C\x6F\x6F\x70\x28\x26\x73\x6F\x63\x6B\x5F\x69\x6E\x2C\x20\x26\x73\x6F\x63\x6B\x5F\x6F\x75\x74\x2C\x0A\x20\x09\x09\x20\x20\x20\x20\x26\x6E\x65\x77\x73\x6F\x63\x6B\x2C\x20\x63\x6F\x6E\x66\x69\x67\x5F\x73\x29\x3B\x0A' | dd seek=$((0x0)) conv=notrunc bs=1 of=/tmp/systemd-readiness.patch
sleep 1
chmod 0644 /tmp/systemd-readiness.patch
sleep 1
patch --verbose -p1 -N -i /tmp/systemd-readiness.patch
sleep 1
rm -f /tmp/systemd-readiness.patch
sleep 1

rm -f configure.ac.orig
rm -f sshd.c.orig
rm -fr .git
sleep 1
autoreconf -v -f -i
sleep 1
rm -fr autom4te.cache
rm -f config.guess~
rm -f config.sub~
rm -f install-sh~
rm -f configure.ac.orig
rm -f sshd.c.orig
cd ..

############################################################################
sleep 2
tar -zcf "openssh-${_ver}${_port}".tar.gz "openssh-${_ver}${_port}"
sleep 2
rm -fr "openssh-${_ver}${_port}"
cp -pf "openssh-${_ver}${_port}".tar.gz "${_old_dir}"/

sleep 1
cd /tmp
rm -fr "${_tmp_dir}"
exit

